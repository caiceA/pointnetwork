<html>
  <head>
    <title>Hello World from Point Network!</title>
    <!-- Use the script below to load pointSDKDemo.js if the Point SDK browser extention is not available
    The pointSDKDemo.js makes calls to the Node ZProxy and can be used to assist development of Node APIs
    Comment out the script tag below that loads pointSDKDemo.js if you want to test using the PointSDK extention-->
    <script type="text/javascript" src="pointSDKDemo.js"></script>
    <style>
      html {
        background-color: black;
        color: white;
        border-color: #333;
      }
      h1, h2, h3, h4, b, a {
        color:gold;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Hello World Example</h1>
      <h2>Demo Storage Layer features and the Point Browser SDK</h2>

      <table>
        <tr>
          <td>Test <b>HelloWorld</b> Event</td>
          <td>Test <b>UpdatedValue</b> Event</td>
        </tr>
        <tr>
          <td><button id="btnSubscribeHelloWorld" onclick="subscribeContractEvent('Hello', 'HelloWorld')">Subscribe</button><button id="btnUnsubscribeHelloWorld" onclick="unsubscribeContractEvent('Hello', 'HelloWorld')">Unsubscribe</button></td>
          <td><button id="btnSubscribeUpdatedValue" onclick="subscribeContractEvent('Hello', 'UpdatedValue')">Subscribe</button><button id="btnUnsubscribeUpdatedValue" onclick="unsubscribeContractEvent('Hello', 'UpdatedValue')">Unsubscribe</button></td>
        </tr>
        <tr>
          <td><button id="btnEmitHelloWorld" onclick="emitHelloWorld()">Emit</button><input type="text" id="txtHelloWorld" value="Tiger" ></input></td>
          <td><button id="btnEmitUpdatedValue" onclick="emitUpdatedValue()">Emit</button><input type="text" id="txtUpdatedValue" value="Durian" ></input></td>
        </tr>
      </table>
      <br />
      <a href="#">Click Here to Test Notifications Extention (if you have it installed)</a>
      <br />
      <br />
      <b>WebSocket Events</b>
      <ul id="wsevents"></ul>
      <b>API Responses</b>
      <p id="results"></p>
    </div>
    <script>
      (async () => {
        // initialize websocket connect to point network node via PointSDK
        // the idea here is to initalize websockets for the app only if needed
        // and to specify the callback that will handle the incomming websocket messages
        socket = window.point.websocket.open(websocketMessageHandler);
        socket.onopen = function() { console.log('WebSocket Client Connected'); }
        let elements = []

        /* START API TEST */
        const RUN_API_TEST = true; // run api test block below?
        if(RUN_API_TEST) {
          // let balance = await window.point.wallet.balance();
          let ping = await window.point.status.ping();
          let address = await window.point.wallet.address();
          let hash = await window.point.wallet.hash();
          let contract = await window.point.contract.load('Hello');
          let callValue = await window.point.contract.call({contract: 'Hello', method: 'value'});
          let callCounter = await window.point.contract.call({contract: 'Hello', method: 'counter'});
          let callEcho = await window.point.contract.call({contract: 'Hello', method: 'echo', params: ['ello??']});
          let callSquare= await window.point.contract.call({contract: 'Hello', method: 'square', params: [2]});
          let callAdd = await window.point.contract.call({contract: 'Hello', method: 'add', params: [3,4]});
          let sendIncrementCounter = await window.point.contract.send({contract: 'Hello', method: 'incrementCounter', gasLimit: 200000});
          // let sendIncrementCounter = await window.point.contract.send({contract: 'Hello', method: 'incrementCounter', gasLimit: 1}); // test 'Gas Limit Too Low
          // let sendIncrementCounter = await window.point.contract.send({contract: 'Hello', method: 'incrementCounter', gasLimit: 21272}); // test 'Out of Gas'
          // let sendIncrementCounter = await window.point.contract.send({contract: 'Hello', method: 'incrementCounter', gasLimit: 200000, amountInWei: '10000000'}); // test VM revert
          // elements.push(`<p>Wallet Balance: ${balance.data.balance}</p>`)
          elements.push(`<p>Ping Test: ${ping.data.ping}</p>`)
          elements.push(`<p>Wallet Address: ${address.data.address}</p>`)
          elements.push(`<p>Hello Smart Contract Address: ${contract.data.address}</p>`)
          elements.push(`<p>Wallet Hash: ${hash.data.hash}</p>`)
          elements.push(`<p>Contract Call Value: ${callValue.data}</p>`)
          elements.push(`<p>Contract Call Counter: ${callCounter.data}</p>`)
          elements.push(`<p>Contract Call Echo: ${callEcho.data}</p>`)
          elements.push(`<p>Contract Call Square: ${callSquare.data}</p>`)
          elements.push(`<p>Contract Call Add: ${callAdd.data}</p>`)
        }
        /* END API TEST */

        let elementsStr = elements.join('')
        document.getElementById("results").innerHTML = `<div>${elementsStr}</div>`
      })()

      // subscriptions manager (which could be part of Point SDK of course)
      // in this example we will set this with the contract name, 'Hello' hardcoded
      // this object should also be persisted into local storage so that
      // the subscription ids for each contract / event pair are still known after referesh
      let contractEventSubscriptions = { 'Hello': {} };

      function addNewContractEventSubscription(contract, event, subscriptionId) {
        contractEventSubscriptions[contract][event] = subscriptionId;
        console.log('contractEventSubscriptions updated', contractEventSubscriptions)
      }

      const SUBSCRIPTION_EVENT_TYPES = {
          CONFIRMATION: 'subscription_confirmation',
          CANCELLATION: 'subscription_cancellation',
          EVENT: 'subscription_event',
          ERROR: 'subscription_error',
      };

      // example of a callback function that can be used to handle data from a websocket
      function websocketMessageHandler(_payload) {
        const payload = JSON.parse(_payload);
        console.log('Received Payload: ', payload);

        const { type, subscriptionId, request, data } = payload;
        const { hostname, params: { contract, event } = {} } = request;
        let msg = '';
        // check this message is for us by checking the hostname
        if(hostname === 'hello.z') {
          switch (type) {
            // if this is a SUBSCRIBED_EVENT then add this new subscription id to the subscriptions manager
            case SUBSCRIPTION_EVENT_TYPES.CONFIRMATION: {
              msg = `SUBSCRIBED: ${contract} contract ${event} events with subscription id ${subscriptionId}`;
              addNewContractEventSubscription(contract, event, subscriptionId);
              break;
            }
            // if this is a UNSUBSCRIBED_EVENT just update the msg for display to the user
            case SUBSCRIPTION_EVENT_TYPES.CANCELLATION: {
              msg = `UNSUBSCRIBED: ${contract} contract ${event} events using subscription id ${subscriptionId}`;
              break;
            }
            // if this is a DATA_EVENT then check the type of the event and switch on that
            case SUBSCRIPTION_EVENT_TYPES.EVENT: {
              // if this is a subscribeContractEvent ...
              if (request.type === 'subscribeContractEvent') {
                // since this is type: 'subscribeContractEvent'
                // we know the params will contain the same keys we used to subscribe to the event
                // which is 'contract' and 'event' so therefore we can check the evnet key
                switch(event) {
                  case 'UpdatedValue':
                    // returnValues will contain an object with oldValue and newValue key
                    // as defined by the Hello Smart Contract UpdatedValue event
                    const {oldValue, newValue} = data.returnValues;
                    msg = `EMIT: UpdatedValue Event - old value: ${oldValue} was changed to ${newValue}`;
                    break;
                  case 'HelloWorld':
                    // returnValues will contain an object with just a message key
                    // as defined by the Hello Smart Contract HelloWorld event
                    const {message} = data.returnValues;
                    msg = `EMIT: HelloWorld Event - Contract says hello: ${message}`
                    break;
                  default:
                    msg = data.message;
                    break;
                }
              }
              break;
            }

            case SUBSCRIPTION_EVENT_TYPES.ERROR:
            default: {
              msg = `SUBSCRIPTION_ERROR: ${data.message}`;
              break;
            }
          }
          let li = document.createElement("li");
          let wsmsg = document.createTextNode(msg);
          li.appendChild(wsmsg);
          document.getElementById("wsevents").appendChild(li);
        }
      }

      async function subscribeContractEvent(contract, event) {
        window.point.contract.subscribe({contract, event});
      }

      async function unsubscribeContractEvent(contract, event) {
        subscriptionId = contractEventSubscriptions[contract][event];
        window.point.subscriptions.removeSubscriptionById({contract, event, subscriptionId});
      }

      async function emitUpdatedValue() {
        document.getElementById('btnEmitUpdatedValue').innerText = 'Processing';
        let value = document.getElementById('txtUpdatedValue').value;
        await window.point.contract.send({contract: 'Hello', method: 'setValue', params: [value]});
        document.getElementById('btnEmitUpdatedValue').innerText = 'Emit';
      }

      async function emitHelloWorld() {
        document.getElementById('btnEmitHelloWorld').innerText = 'Processing';
        let value = document.getElementById('txtHelloWorld').value;
        await window.point.contract.send({contract: 'Hello', method: 'emitHelloWorldEvent', params: [value]});
        document.getElementById('btnEmitHelloWorld').innerText = 'Emit';
      }
    </script>
  </body>
</html>